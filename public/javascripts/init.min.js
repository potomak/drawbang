var currentColor="#000000",copyFrameIndex=-1,tips=!0;function postUploadCallback(a){"undefined"!=typeof a.thumb?($("#images").prepend(a.thumb),clearAll(),trackEvent("Save",a.url),postDrawAction(a.share_url),showFacebookDialog(a.share_url,a.url)):trackEvent("Error",a)}
function performUpload(){var a=PIXEL.toObject();PIXEL.log(a);"undefined"!=typeof parentId&&(a.parent=parentId);$.ajax({url:"/upload",type:"POST",contentType:"application/json",processData:!1,data:JSON.stringify(a),success:postUploadCallback,dataType:"json"});disable($("#upload")).unbind("click");disable($("#clear"))}function upload(){confirm("Want to save?")&&("undefined"!=typeof userUid?performUpload():(tryingToSave=!0,$("a.popup").trigger("click")));return!1}
function ctrlKey(a){return navigator.platform.match(/mac/i)?a.metaKey:a.ctrlKey}function clearAll(){for(var a=PIXEL.getFramesLength()-1;0<=a;a--)PIXEL.log("REMOVE "+a+" FRAME OF "+PIXEL.getFramesLength()+" FRAMES!"),PIXEL.clearCanvasAt(a),PIXEL.removeFrame(a),disable($(".frame[data-frame="+a+"]"));PIXEL.setCurrentFrame(0);deactivate($(".frame.active"));activate($(".frame[data-frame=0]"));enable($(".frame[data-frame=0]"));disable($(".remove_frame"));enable($(".add_frame"));copyFrameIndex=-1}
function deactivate(a){return a.removeClass("active")}function activate(a){return a.addClass("active")}function disable(a){return a.addClass("disabled")}function enable(a){return a.removeClass("disabled")}function isEnabled(a){return 0<a.size()&&!a.hasClass("disabled")}function trackEvent(a,b){_gaq.push(["_trackEvent","Drawings",a,b])}
function showFacebookDialog(a,b){FB.ui({method:"feed",name:"My brand new drawing",link:a,picture:b,caption:"Check my drawing out!",description:"Do you like it?",message:"My new awesome pixel art!",actions:[{name:"Fork this drawing!",link:a+"/fork"}]},function(c){c&&c.post_id&&(trackEvent("Post",b),showFacebookRequestDialog(a,b))})}
function showFacebookRequestDialog(a,b){FB.ui({method:"apprequests",message:"Would you like to fork my new awesome pixel art?",title:"Draw pixel art with your friends",data:a},function(a){a&&a.to&&trackEvent("Request",b)})}function postDrawAction(a){FB.api("/me/drawbang:draw","post",{drawing:a},function(a){(!a||a.error)&&console&&console.log(a)})}
function getCoordinates(a){return{x:a.offsetX?a.offsetX:a.pageX-a.target.parentNode.offsetLeft,y:a.offsetY?a.offsetY:a.pageY-a.target.parentNode.offsetTop}}function mouseDownCallback(a){PIXEL.setDraw(!0);a=getCoordinates(a);PIXEL.doAction(a.x,a.y,currentColor);isEnabled($("#upload"))||(enable($("#upload")).bind("click",upload),enable($("#clear")))}function mouseMoveCallback(a){var b=getCoordinates(a);PIXEL.doAction(b.x,b.y,currentColor);a.preventDefault()}
function mouseUpCallback(){PIXEL.setDraw(!1)}function playStop(){$(".play_stop").hasClass("stop")?PIXEL.stop():PIXEL.play(5,function(a){deactivate($(".frame.active"));$(".frame").each(function(){$(this).data("frame")==a&&activate($(this))})});$(".play_stop").toggleClass("stop")}
function addFrame(){isEnabled($(".add_frame"))&&(PIXEL.setCurrentFrame(PIXEL.getFramesLength()),maxFrames==PIXEL.getFramesLength()&&disable($(".add_frame")),enable($(".remove_frame")),enable($(".frame[data-frame="+(PIXEL.getFramesLength()-1)+"]")),$(".frame.active").toggleClass("active"),$(".frame[data-frame="+(PIXEL.getFramesLength()-1)+"]").toggleClass("active"),PIXEL.log(["add_frame",PIXEL.getFramesLength()]))}
function removeFrame(){isEnabled($(".remove_frame"))&&(PIXEL.clearCanvasAt(PIXEL.getFramesLength()-1),PIXEL.removeFrame(PIXEL.getFramesLength()-1),PIXEL.setCurrentFrame(PIXEL.getFramesLength()-1),1==PIXEL.getFramesLength()&&disable($(".remove_frame")),enable($(".add_frame")),disable($(".frame[data-frame="+PIXEL.getFramesLength()+"]")),$(".frame.active").toggleClass("active"),$(".frame[data-frame="+(PIXEL.getFramesLength()-1)+"]").toggleClass("active"),PIXEL.log(["remove_frame, done",PIXEL.getFramesLength()]))}
function setFrame(a){isEnabled($(".frame[data-frame="+a+"]"))&&(PIXEL.setCurrentFrame(a),deactivate($(".frame.active")),activate($(".frame[data-frame="+a+"]")))}
$(document).ready(function(){var a=$("#canvas canvas"),b=$(".frames canvas");if("undefined"!=typeof imageData){if(PIXEL.init(a[0],b,!productionEnv,imageData),1<imageData.length)for(maxFrames==PIXEL.getFramesLength()&&disable($(".add_frame")),1<PIXEL.getFramesLength()&&enable($(".remove_frame")),b=1;b<PIXEL.getFramesLength();b++)enable($(".frame[data-frame="+b+"]"))}else PIXEL.init(a[0],b,!productionEnv);a.mousedown(mouseDownCallback).mousemove(mouseMoveCallback);a.bind("touchstart",mouseDownCallback).bind("touchmove",
mouseMoveCallback);$(document).mouseup(mouseUpCallback);$(document).bind("touchend",mouseUpCallback);$("#clear").click(function(){isEnabled($("#upload"))&&confirm("Sure?")&&(clearAll(),disable($("#upload")).unbind("click"),disable($("#clear")))});$(".action.selectable").click(function(){PIXEL.setAction($(this).data("action"));deactivate($(".action.selectable.active"));activate($(this))});$(".color").click(function(){currentColor=$(this).data("color");deactivate($(".color.active"));activate($(this))});
$(".undo").click(function(){PIXEL.undo()});$(".frame").click(function(){setFrame($(this).data("frame"))});$(".add_frame").click(addFrame);$(".remove_frame").click(removeFrame);$(".play_stop").click(playStop);$(".move_right").click(function(){PIXEL.moveRight()});$(".move_top").click(function(){PIXEL.moveTop()});$(".flip_horizontal").click(function(){PIXEL.flipHorizontal()});$(".flip_vertical").click(function(){PIXEL.flipVertical()});$(".copy").click(function(){copyFrameIndex=PIXEL.getCurrentFrameId()});
$(".paste").click(function(){-1<copyFrameIndex&&copyFrameIndex<PIXEL.getFramesLength()&&PIXEL.pasteFrameAt(copyFrameIndex)});$(".rotate").click(function(){PIXEL.rotate()});$(document).keydown(function(a){if(ctrlKey(a))switch(a.keyCode){case 90:return PIXEL.undo(),!1;case 67:return copyFrameIndex=PIXEL.getCurrentFrameId(),!1;case 86:return-1<copyFrameIndex&&copyFrameIndex<PIXEL.getFramesLength()&&PIXEL.pasteFrameAt(copyFrameIndex),!1;case 83:return isEnabled($("#upload"))&&upload(),!1}switch(a.keyCode){case 66:return PIXEL.setAction("pixel"),
deactivate($(".action.selectable.active")),activate($(".action.selectable.pixel")),!1;case 71:return PIXEL.setAction("fill"),deactivate($(".action.selectable.active")),activate($(".action.selectable.fill")),!1;case 69:return PIXEL.setAction("clearPixel"),deactivate($(".action.selectable.active")),activate($(".action.selectable.clearPixel")),!1;case 38:return PIXEL.moveTop(),!1;case 39:return PIXEL.moveRight(),!1;case 32:return playStop(),!1;case 188:return removeFrame(),!1;case 190:return addFrame(),
!1;case 33:return setFrame(PIXEL.getCurrentFrameId()-1),!1;case 34:return setFrame(PIXEL.getCurrentFrameId()+1),!1}});$("#toggle_tips").change(function(){tips=$(this).is(":checked")});$.each(".pixel .fill .clearPixel .copy .paste .undo .move_top .move_right .flip_horizontal .flip_vertical .rotate .play_stop .frames .remove_frame .add_frame #upload #clear".split(" "),function(a,b){$(b).tipsy({gravity:"nw",title:function(){return tips?this.getAttribute("original-title"):""}})})});
