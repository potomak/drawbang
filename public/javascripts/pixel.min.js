var PIXEL=function(){var n=!1,g=[],b=null,d=0,h=null,p=[],w=!1,u="pixel",z={pixelSize:1,size:16,gridColor:"#eeeeee",showGrid:!1},v={pixelSize:20,size:320,gridColor:"#eeeeee",showGrid:!1},l={undo:[]},x=function(){var a=v.size/v.pixelSize;g[d]=new Bitmap(a,a)},m=function(a){n&&console.log([(new Date).toString(),a])},t=function(a,c,k){var f=e().data[a][c];return f!=k?(e().data[a][c]=k,q(),f):!1},A=function(a,c,k){var f=e().getColorAt(a,c);m("flood fill startColor: "+f+", color: "+k+", ("+a+", "+c+")");
if(f!=k){var h=e().clone(),b=(new Date).getTime();s(a,c,f,k);m("flood fill time: "+((new Date).getTime()-b));q();return h.data}return!1},s=function(a,c,k,f){0<=a&&(a<e().data.length&&0<=c&&c<e().data.length)&&e().getColorAt(a,c)==k&&(e().data[a][c]=f,s(a+1,c,k,f),s(a-1,c,k,f),s(a,c+1,k,f),s(a,c-1,k,f))},q=function(a){"undefined"==typeof a?a=e().data:(g[d]=new Bitmap(a.length,a.length),e().importBitmapData(a));h.clearCanvas();p[d].clearCanvas();h.draw(a);p[d].draw(a)},e=function(){return g[d]},y=function(a){m("setCurrentFrame: "+
a);var c=d;d=a;"undefined"==typeof e()&&x();c!=d&&(l={undo:[]},q())},r=function(a){var c=(new Date).getTime(),k=Array.prototype.slice.call(arguments,1),f=e().clone();a.apply(this,[f].concat(k));m("applyTransformation, "+k+" - "+((new Date).getTime()-c));q();l.undo.push(function(){q(f.data)})};return{TRANSPARENT:"rgba(0, 0, 0, 0)",init:function(a,c,e,f){h=new Canvas(a,v);for(a=0;a<c.length;a++)p[a]=new Canvas(c[a],z);"undefined"!=typeof e?n=e:null;x();if("undefined"!=typeof f)for(h.clearCanvas(),h.draw(f[0]),
c=0;c<f.length;c++)g[c]=new Bitmap(f[c].length,f.length),g[c].importBitmapData(f[c]),p[c].clearCanvas(),p[c].draw(f[c]);else null;l={undo:[]};q()},clearCanvasAt:function(a){m("clearCanvasAt:"+a+", frames.length: "+g.length);p[a].clearCanvas();d==a&&h.clearCanvas()},removeFrame:function(a){g.splice(a,1);m("removeFrame:"+a+", frames.length: "+g.length)},setDraw:function(a){w=a},setAction:function(a){u=a},doAction:function(a,c,e){if(w){var f=h.quantize(a),b=h.quantize(c);switch(u){case "pixel":var d=
t(f,b,e);!1!=d&&l.undo.push(function(){t(f,b,d)});break;case "clearPixel":d=t(f,b,"rgba(0, 0, 0, 0)");!1!=d&&l.undo.push(function(){t(f,b,d)});break;case "fill":var p=A(f,b,e);!1!=d&&l.undo.push(function(){q(p)});break;default:m("unknown action:"+u)}}},getHistory:function(){return l},undo:function(){0<l.undo.length&&l.undo.pop().call()},getFramesLength:function(){return g.length},setCurrentFrame:y,getCurrentFrame:e,getCurrentFrameId:function(){return d},play:function(a,c){1<g.length&&(b=setInterval(function(){activeFrame=
(d+1)%g.length;m(["play animation","activeFrame: "+activeFrame,"currentFrame: "+d,"frames.length: "+g.length]);y(activeFrame);c(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(b);b=null},moveRight:function(){r(function(){for(j=0;j<e().data[0].length;j++){var a=e().data[e().data.length-1][j];for(i=e().data.length-1;0<i;i--)e().data[i][j]=e().data[i-1][j];e().data[0][j]=a}})},moveTop:function(){r(function(){for(var a=0;a<e().data.length;a++)e().data[a].push(e().data[a].shift())})},flipHorizontal:function(){r(function(){for(var a=
e().data.length,c=0;c<e().data.length/2;c++)for(var b=0;b<e().data[c].length;b++){var f=e().data[c][b];e().data[c][b]=e().data[a-1-c][b];e().data[a-1-c][b]=f}})},flipVertical:function(){r(function(){for(var a=0;a<e().data.length;a++)for(var c=0;c<e().data[a].length/2;c++){var b=e().data[a][c],f=e().data[a].length;e().data[a][c]=e().data[a][f-1-c];e().data[a][f-1-c]=b}})},rotate:function(){r(function(a){for(var c=0;c<e().data.length;c++)for(var b=0;b<e().data[c].length;b++)e().data[c][b]=a.data[e().data[c].length-
1-b][c]})},pasteFrameAt:function(a){r(function(a,b){g[d]=g[b].clone()},a)},toObject:function(){var a={image:null};if(1<g.length){a.image={frames:[]};for(var c=0;c<g.length;c++)a.image.frames.push(g[c].data)}else a.image={frame:e().data};return a},log:m}}();
function Canvas(n,g){this.canvas=n;this.ctx=n.getContext("2d");this.settings=g;this.clearCanvas=function(){this.canvas.width=this.canvas.width};this.drawGrid=function(){for(var b=0.5+this.settings.pixelSize;b<this.settings.size;b+=this.settings.pixelSize)this.ctx.moveTo(b,0),this.ctx.lineTo(b,this.settings.size),this.ctx.moveTo(0,b),this.ctx.lineTo(this.settings.size,b);this.ctx.strokeStyle=this.settings.gridColor;this.ctx.stroke()};this.getDataURL=function(){return this.canvas.toDataURL("image/png")};
this.draw=function(b){this.clearCanvas();for(var d=0;d<b.length;d++)for(var h=0;h<b[d].length;h++)this.ctx.fillStyle=b[d][h],this.ctx.fillRect(d*this.settings.pixelSize,h*this.settings.pixelSize,this.settings.pixelSize,this.settings.pixelSize);this.settings.showGrid&&this.drawGrid()};this.quantize=function(b){b=Math.floor(b/this.settings.pixelSize);var d=this.settings.size/this.settings.pixelSize;b>=d&&(b=d-1);0>=b&&(b=0);return b}}
function Bitmap(n,g){this.width=n;this.height=g;this.data=[];for(var b=0;b<n;b++){this.data.push(Array(g));for(var d=0;d<this.data[b].length;d++)this.data[b][d]=PIXEL.TRANSPARENT}this.toString=function(){for(var b="",d=0;d<this.data.length;d++){for(var g=0;g<this.data[d].length;g++)b+=(PIXEL.TRANSPARENT==this.data[d][g]?" ":"X")+", ";b+="\n"}return b};this.clone=function(){for(var b=new Bitmap(this.width,this.height),d=0;d<this.data.length;d++)b.data[d]=this.data[d].slice();return b};this.importBitmapData=
function(b){this.data=b.slice();for(var d=0;d<b.length;d++)this.data[d]=b[d].slice()};this.getColorAt=function(b,d){return PIXEL.TRANSPARENT==this.data[b][d]?null:this.data[b][d]}};
